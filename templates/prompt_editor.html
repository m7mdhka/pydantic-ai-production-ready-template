{% extends "layout.html" %}

{% block content %}
<style>
    /* Full height layout adjustments */
    .prompt-wrapper {
        height: calc(100vh - 80px); /* Adjust based on navbar */
        display: flex;
        flex-direction: column;
        padding: 1rem;
    }

    .editor-layout {
        display: flex;
        flex: 1;
        gap: 15px;
        min-height: 0; /* allows children scroll */
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
    }

    /* Sidebar - List of Prompts */
    .sidebar-list {
        flex: 0 0 250px;
        border-right: 1px solid #e0e0e0;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
    }
    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
    }
    .list-scroll {
        overflow-y: auto;
        flex: 1;
    }

    /* Main Editor Area */
    .main-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        background: #fff;
        min-width: 0;
    }

    .editor-header {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        background: #fff;
    }

    .code-area {
        flex: 1;
        padding: 15px;
        background: #fafafa;
        display: flex;
        flex-direction: column;
    }

    .prompt-textarea {
        flex: 1;
        width: 100%;
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        font-size: 14px;
        line-height: 1.6;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #ffffff;
        resize: none;
        outline: none;
        color: #333;
    }
    .prompt-textarea:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    /* Right Sidebar - History */
    .sidebar-history {
        flex: 0 0 300px;
        border-left: 1px solid #e0e0e0;
        background: #fff;
        display: flex;
        flex-direction: column;
    }

    /* Utility */
    .text-mono { font-family: monospace; }
    .version-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.1s;
    }
    .version-item:hover { background: #f8f9fa; }
    .version-item.active { background: #e8f0fe; border-left: 3px solid #007bff; }
    .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #ccc; }
    .status-dot.active { background: #28a745; }
</style>

<div class="container-fluid prompt-wrapper">
    <div class="editor-layout shadow-sm">

        <!-- LEFT: Sidebar List -->
        <div class="sidebar-list">
            <div class="sidebar-header">
                <span class="font-weight-bold">Prompts</span>
                <a href="{{ url_for('admin:prompt_editor') }}" class="btn btn-sm btn-outline-dark" title="New Prompt">
                    <i class="fa fa-plus"></i>
                </a>
            </div>
            <div class="list-scroll list-group list-group-flush">
                {% for p in prompts %}
                <a href="?prompt_id={{ p.id }}"
                   class="list-group-item list-group-item-action {% if (p.id | string) == current_prompt_id %}active{% endif %} border-0">
                    <div class="d-flex w-100 justify-content-between">
                        <span class="font-weight-bold text-truncate">{{ p.slug }}</span>
                    </div>
                    <small class="{% if (p.id | string) == current_prompt_id %}text-light{% else %}text-muted{% endif %} text-truncate d-block">
                        {{ p.name }}
                    </small>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- CENTER: Editor -->
        <div class="main-editor">
            <form method="post" id="promptForm" class="h-100 d-flex flex-column">
                <input type="hidden" name="action" value="save_commit">
                <input type="hidden" name="prompt_id" value="{{ selected_prompt.id if selected_prompt else '' }}">

                <!-- Metadata Header -->
                <div class="editor-header">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="m-0">
                                {% if selected_prompt %}{{ selected_prompt.name }}{% else %}Create New Prompt{% endif %}
                            </h5>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fa fa-save mr-1"></i> Save Version
                        </button>
                    </div>

                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white text-muted">Slug</span>
                                </div>
                                <input type="text" name="slug" class="form-control text-mono" required
                                       placeholder="e.g. customer_support_agent"
                                       value="{{ selected_prompt.slug if selected_prompt else '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white text-muted">Name</span>
                                </div>
                                <input type="text" name="name" class="form-control" required
                                       placeholder="Readable name"
                                       value="{{ selected_prompt.name if selected_prompt else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Area -->
                <div class="code-area">
                    <textarea name="content" id="promptContent" class="prompt-textarea" required
                        placeholder="Write your prompt here... Use {variable} for python formatting.">{{ selected_prompt.content if selected_prompt else '' }}</textarea>

                    <div class="mt-3">
                        <input type="text" name="commit_message" class="form-control form-control-sm"
                               placeholder="Commit message (e.g. 'Adjusted tone to be more polite')" required>
                    </div>
                </div>
            </form>
        </div>

        <!-- RIGHT: History -->
        <div class="sidebar-history">
            <div class="sidebar-header">
                <span class="font-weight-bold text-muted">Version History</span>
            </div>
            <div class="list-scroll">
                {% if selected_prompt and selected_prompt.versions %}
                    {% for ver in selected_prompt.versions %}
                    <div class="version-item {% if ver.is_active %}active{% endif %}" onclick="viewVersion(`{{ ver.content | replace('`', '\\`') | replace('\n', '\\n') }}`)">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge badge-light border">v{{ ver.version_number }}</span>
                            <small class="text-muted">{{ ver.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <div class="small text-dark mb-1 font-weight-bold text-truncate">
                            {{ ver.commit_message or 'Update' }}
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            {% if ver.is_active %}
                                <span class="badge badge-success" style="font-size: 10px;">ACTIVE</span>
                            {% else %}
                                <span class="text-muted" style="font-size: 10px;">Inactive</span>
                                <form method="post" style="display:inline;">
                                    <input type="hidden" name="action" value="activate_version">
                                    <input type="hidden" name="prompt_id" value="{{ selected_prompt.id }}">
                                    <input type="hidden" name="version_id" value="{{ ver.id }}">
                                    <button type="submit" class="btn btn-xs btn-outline-primary py-0" style="font-size: 10px;">
                                        Rollback
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="p-4 text-center text-muted small">
                        No history available.
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<script>
    // Just a simple viewer helper
    function viewVersion(content) {
        // Decode python/html specifics if needed, usually jinja handles it
        // We just replace the textarea content visually to let user see old versions
        const textarea = document.getElementById('promptContent');
        textarea.value = content.replace(/\\n/g, '\n').replace(/\\`/g, '`');

        // Visual flash to indicate data changed
        textarea.style.backgroundColor = "#fffbe6";
        setTimeout(() => { textarea.style.backgroundColor = "#ffffff"; }, 300);
    }
</script>
{% endblock %}
